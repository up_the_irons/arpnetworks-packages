Description: fix denial of service via keepalive feature
Origin: backport, http://libvirt.org/git/?p=libvirt.git;a=commit;h=173c2914734eb5c32df6d35a82bf503e12261bcf
Origin: backport, http://libvirt.org/git/?p=libvirt.git;a=commit;h=066c8ef6c18bc1faf8b3e10787b39796a7a06cc0
Bug-Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=735676
Bug-Redhat: https://bugzilla.redhat.com/show_bug.cgi?id=1047577

Index: libvirt-0.9.8/src/rpc/virnetserverclient.c
===================================================================
--- libvirt-0.9.8.orig/src/rpc/virnetserverclient.c	2014-01-20 15:13:17.327367038 -0500
+++ libvirt-0.9.8/src/rpc/virnetserverclient.c	2014-01-20 15:13:17.319367038 -0500
@@ -1214,9 +1214,22 @@
 int
 virNetServerClientStartKeepAlive(virNetServerClientPtr client)
 {
-    int ret;
+    int ret = -1;
+
     virNetServerClientLock(client);
+
+    /* The connection might have been closed before we got here and thus the
+     * keepalive object could have been removed too.
+     */
+    if (!client->keepalive) {
+        virReportError(VIR_ERR_INTERNAL_ERROR, "%s",
+                       _("connection not open"));
+        goto cleanup;
+    }
+
     ret = virKeepAliveStart(client->keepalive, 0, 0);
+
+cleanup:
     virNetServerClientUnlock(client);
     return ret;
 }
